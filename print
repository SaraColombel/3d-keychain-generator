#!/usr/bin/env bash

# --- V√©rification des arguments ---
if [ $# -lt 2 ]; then
    echo "Usage: $0 <prenom> <filament>"
    exit 1
fi

# --- R√©cup√®re le dossier du script ---
SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
cd "$SCRIPT_DIR"

NAME="$1"
FILAMENT=$(echo "$2" | tr '[:upper:]' '[:lower:]')

UPPER_NAME=$(echo "$NAME" | tr '[:lower:]' '[:upper:]')
LOWER_NAME=$(echo "$NAME" | tr '[:upper:]' '[:lower:]')

STL_DIR="$SCRIPT_DIR/keychain_stl"
GCODE_DIR="$SCRIPT_DIR/keychain_gcode"
mkdir -p "$STL_DIR" "$GCODE_DIR"

STL_FILE="$STL_DIR/keychain_${LOWER_NAME}.stl"
GCODE_FILE="$GCODE_DIR/keychain_${LOWER_NAME}_${FILAMENT}.gcode"

# --- G√©n√©ration STL ---
if [ ! -f "$STL_FILE" ]; then
    echo "üß± G√©n√©ration STL..."
    openscad -o "$STL_FILE" -D "name=\"$UPPER_NAME\"" keychain.scad >/dev/null 2>&1 || exit 1
else
    echo "‚ö†Ô∏è  STL d√©j√† existant : $(basename "$STL_FILE")"
fi

# --- V√©rifie si le G-code existe d√©j√† ---
if [ -f "$GCODE_FILE" ]; then
    echo "‚ö†Ô∏è  G-code d√©j√† existant : $(basename "$GCODE_FILE")"
    read -p "Souhaitez-vous le r√©g√©n√©rer ? (o/N) " -r
    if [[ ! $REPLY =~ ^[Oo]$ ]]; then
        echo "üö´ Slicing annul√©. Fichier conserv√©."
        exit 0
    fi
fi

# --- Slicing avec PrusaSlicer ---
echo "üåÄ Slicing du STL en G-code..."

prusa-slicer \
  --load "$SCRIPT_DIR/slicer_profiles/printer/Artillery_Genius.ini" \
  --load "$SCRIPT_DIR/slicer_profiles/filament/${FILAMENT}.ini" \
  --load "$SCRIPT_DIR/slicer_profiles/process/0.2mm_quality.ini" \
  --export-gcode \
  --output "$GCODE_FILE" \
  "$STL_FILE" >/dev/null 2>&1

# --- V√©rification du r√©sultat ---
if [ -f "$GCODE_FILE" ]; then
    echo "‚úÖ G-code g√©n√©r√© : $(basename "$GCODE_FILE")"

    PRINT_TIME=$(grep -iE '^; estimated printing time' "$GCODE_FILE" | sed 's/^; estimated printing time (normal mode) = //I')
    if [ -n "$PRINT_TIME" ]; then
        echo "üïí Temps estim√© : $PRINT_TIME"
    else
        echo "‚ÑπÔ∏è  Temps d'impression non trouv√© dans le G-code."
    fi
else
    echo "‚ùå √âchec : G-code non trouv√© dans $GCODE_DIR"
    exit 1
fi

